<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>è–èª•äº¤æ›ç¦®ç‰©æŠ½ç±¤ï¼ˆå³å ´æŠ½å‹•ç•«ï¼‰</title>
  <style>
    body{max-width:460px; margin:36px auto; font-family:sans-serif;}
    #allnames, #drawarea{margin:20px 0;}
    #flipCard{margin:22px auto;width:260px;height:120px;perspective:700px;}
    .flipInner{width:100%;height:100%;transition:.7s;transform-style:preserve-3d;position:relative;}
    .flipInner.flipped{transform:rotateY(180deg);}
    .flipFront,.flipBack{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2em;border:2px solid #6cf;border-radius:15px;background:#fff;}
    .flipBack{background:linear-gradient(120deg,#fef,#9fd);transform:rotateY(180deg);}
    input,button{margin:6px 2px;padding:2px 8px;}
    textarea{width:250px;}
  </style>
</head>
<body>
  <h2>è–èª•äº¤æ›ç¦®ç‰©ç¾å ´æŠ½ï¼ˆæœ‰å‹•ç•«ï¼‰</h2>
  <div id="setup">
    <p>ä¸€æ¬¡æ€§è¼¸å…¥æ‰€æœ‰åƒåŠ è€…åï¼ˆæ¯è¡Œä¸€å€‹ï¼Œå»ºè­°è‡ªå·±æŠ„åº•ï¼‰ï¼š</p>
    <textarea id="allnames" rows="7" placeholder="Alex&#10;Bonnie&#10;Charlie..."></textarea>
    <br><button onclick="startGame()">é–‹å§‹é€²å…¥æŠ½ç±¤éšæ®µ</button>
  </div>

  <div id="drawarea" style="display:none;">
    <p><b>ç¬¬ <span id="curNum"></span> ä½åƒåŠ è€…æŠ½ç±¤ï¼š</b></p>
    ä½ å«ä¹œåï¼Ÿ<input id="myName" autocomplete="off">
    <button onclick="drawSecret()">æŠ½é…å°ï¼</button>
    <div id="flipCard" style="display:none;">
      <div class="flipInner" id="flipInner">
        <div class="flipFront" onclick="flip()">é»æˆ‘ç¿»ç‰Œï¼</div>
        <div class="flipBack" id="secretResult"></div>
      </div>
    </div>
    <p id="remind"></p>
  </div>

  <script>
    let namesList = [];
    let remainingDrawNames = [];
    let assigned = {};
    let round = 1;

    // Derangement: ç„¡äººæŠ½è‡ªå·±
    function derangement(arr, banned) {
      let trys=0, n=arr.length, arr2=arr.slice();
      while(true){
        for(let i=n-1;i>0;i--){
          let j=Math.floor(Math.random()*(i+1));
          [arr2[i],arr2[j]]=[arr2[j],arr2[i]];
        }
        let valid = true;
        for(let i=0;i<n;i++){
          if(arr2[i]===banned[i]) valid=false;
        }
        // æ¸›äº’æŠ½
        for(let i=0;i<n;i++){
          if(arr2[arr2[i]]===banned[i]) valid=false;
        }
        if(valid) break;
        trys++; if(trys>30) break;
      }
      let failSafe=0;
      while(arr2.some((x,i)=>x===banned[i])) {
        for(let i=n-1;i>0;i--){
          let j=Math.floor(Math.random()*(i+1));
          [arr2[i],arr2[j]]=[arr2[j],arr2[i]];
        }
        failSafe++; if(failSafe>40) break;
      }
      return arr2;
    }

    function startGame(){
      namesList = allnames.value.split('\n').map(x=>x.trim()).filter(x=>x);
      if(namesList.length<3){
        alert('è‡³å°‘3äººï¼');
        return;
      }
      if(new Set(namesList).size !== namesList.length){
        alert('å””å¥½æœ‰é‡è¤‡åï¼');
        return;
      }
      remainingDrawNames = namesList.slice();
      assigned = {};
      document.getElementById('setup').style.display='none';
      document.getElementById('drawarea').style.display='';
      document.getElementById('curNum').textContent = round;
      document.getElementById('remind').textContent = `ä»²æœ‰ ${namesList.length+1-round} ä½æœªæŠ½`;
    }

    function drawSecret(){
      let me = myName.value.trim();
      if(!me) {alert('è«‹è¼¸å…¥ä½ å€‹å');return;}
      if(!remainingDrawNames.includes(me)) {alert('ä½ å””ä¿‚åŸåå–®å…§ï¼ŒæŠ„éŒ¯å’—å‘€ï¼Ÿ');return;}
      if(assigned[me]) {alert('ä½ æŠ½éå•¦ï¼');return;}
      let others = remainingDrawNames.filter(n=>n!==me);
      if(others.length===0){
        alert('æœ€å¾Œä¸€ä½è‡ªå‹•åˆ†é…ï¼Œä¸ç”¨å†æŠ½ï¼');
        return;
      }
      // derangement of remaining names (excludeè‡ªå·±)
      let resultArr = derangement(others, others);
      let pair;
      do {
        let idx = Math.floor(Math.random()*resultArr.length);
        pair = resultArr[idx];
      } while(pair===me || pair in assigned);

      assigned[me] = pair;
      remainingDrawNames.splice(remainingDrawNames.indexOf(me),1);
      document.getElementById('flipCard').style.display='';
      document.getElementById('flipInner').classList.remove('flipped');
      document.getElementById('secretResult').innerHTML = `<b>${me}</b> ä½ è¦é€ç¦®ç‰©ä¿¾ ğŸ‘‰ <span style="color:#B23">${pair}</span>ï¼`;
      myName.value = '';
      round++;
      document.getElementById('curNum').textContent = round;
      if(remainingDrawNames.length===0){
        document.getElementById('remind').textContent = 'å·²å…¨éƒ¨æŠ½å®Œï¼Œå¯ä»¥å»æº–å‚™ç¦®ç‰©å•¦ï¼';
      } else {
        document.getElementById('remind').textContent = `ä»²æœ‰ ${remainingDrawNames.length} ä½æœªæŠ½`;
      }
    }
    function flip(){
      document.getElementById('flipInner').classList.add('flipped');
    }
  </script>
</body>
</html>
