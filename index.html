<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <title>2025å¹´åº¦è–èª•äº¤æ›ç¦®ç‰©æŠ½ç</title>
  <style>
    body{max-width:520px;margin:36px auto;font-family:sans-serif;}
    #entry, #drawarea{margin:18px 0;}
    #lotteryCard{margin:35px auto;width:310px;height:160px;perspective:900px;}
    .flipInner{width:100%;height:100%;transition:.6s;transform-style:preserve-3d;position:relative;}
    .flipInner.flipped{transform:rotateY(180deg);}
    .flipFront,.flipBack{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2em;border:2.5px solid #62e;border-radius:20px;background:#fff;}
    .flipBack{background:linear-gradient(135deg,#f8f,#cef);transform:rotateY(180deg);}
    input,button{margin:6px 2px;padding:6px 10px;font-size:1.2em;}
    #nameList{width:280px;}
    h1{margin-bottom:.6em;}
    #resetBtn{margin:15px 0;background:#eaf;padding:6px 14px;}
  </style>
</head>
<body>
  <h1>2025å¹´åº¦è–èª•äº¤æ›ç¦®ç‰©æŠ½ç</h1>

  <button id="resetBtn" onclick="resetAll()">ğŸ†•> é‡æ–°åˆ†æ´¾ï¼ˆOrganizerå°ˆç”¨ï¼‰</button>

  <div id="entry">
    <b>è«‹é¸æ“‡ä½ çš„åå­—ï¼š</b>
    <select id="myName">
      <option value="">è«‹é¸æ“‡</option>
      <option>kitty</option>
      <option>e0</option>
      <option>may</option>
      <option>tiff</option>
      <option>snow</option>
      <option>manying</option>
    </select>
    <button onclick="beginLuckyDraw()">æŠ½æŠ½çœ‹ï¼</button>
  </div>
  <div id="drawarea" style="display:none;">
    <div id="lotteryCard" style="display:none;">
      <div class="flipInner" id="flipInner">
        <div class="flipFront" onclick="flip()">é»æˆ‘æŠ½å‡º2025å¹´åº¦é€ç¦®å°è±¡</div>
        <div class="flipBack" id="drawResult"></div>
      </div>
    </div>
    <div id="reminder"></div>
  </div>
  <script>
    // åå–®
    const names = ["kitty","e0","may","tiff","snow","manying"];
    
    // Pairingï¼ˆä¿å­˜åœ¨ localStorageï¼‰
    let assigned = JSON.parse(localStorage.getItem('santaPairs2025')||'null');
    let drawn = JSON.parse(localStorage.getItem('santaDrawn2025')||'{}');

    // Derangement function
    function generatePairing(namelist) {
      let tries=0, n=namelist.length, arr2=namelist.slice();
      while(true){
        for(let i=n-1;i>0;i--){
          let j=Math.floor(Math.random()*(i+1));
          [arr2[i],arr2[j]]=[arr2[j],arr2[i]];
        }
        let ok = true;
        for(let i=0;i<n;i++)
          if(arr2[i]===namelist[i]) ok = false;
        for(let i=0;i<n;i++)
          if(arr2[arr2[i]]===namelist[i]) ok = false;
        if(ok) break;
        tries++; if(tries>30) break;
      }
      let failSafe=0;
      while(arr2.some((x,i)=>x===namelist[i])) {
        for(let i=n-1;i>0;i--){
          let j=Math.floor(Math.random()*(i+1));
          [arr2[i],arr2[j]]=[arr2[j],arr2[i]];
        }
        failSafe++; if(failSafe>40) break;
      }
      let map={},used=new Set();
      namelist.forEach((me,i)=>{ map[me]=arr2[i]; used.add(arr2[i]); });
      return map;
    }

    // é¦–æ¬¡/è¢«reset: ç”Ÿæˆ pairing
    function ensurePairing(){
      assigned = JSON.parse(localStorage.getItem('santaPairs2025')||'null');
      drawn = JSON.parse(localStorage.getItem('santaDrawn2025')||'{}');
      if(!assigned || Object.keys(assigned).length!==names.length) {
        assigned = generatePairing(names);
        localStorage.setItem('santaPairs2025',JSON.stringify(assigned));
        drawn = {};
        localStorage.setItem('santaDrawn2025',JSON.stringify(drawn));
      }
    }
    ensurePairing();

    function beginLuckyDraw(){
      let sel = document.getElementById("myName").value;
      ensurePairing();
      if(!sel) {alert("è«‹é¸æ“‡ä½ çš„åå­—ï¼");return;}
      if(!names.includes(sel)){alert("å””ä¿‚åƒåŠ åå–®");return;}
      if(drawn[sel]){
        showOnceOnly(sel,true);
        return;
      }
      document.getElementById('entry').style.display='none';
      document.getElementById('drawarea').style.display='';
      document.getElementById('lotteryCard').style.display='';
      document.getElementById('flipInner').classList.remove('flipped');
      document.getElementById('drawResult').innerHTML = `<span style="font-weight:bold;">${sel}</span> ä½ è¦é€ç¦®ç‰©ä¿¾ ğŸ‘‰ <span style="color:#962">${assigned[sel]}</span>ï¼`;
      drawn[sel] = true;
      localStorage.setItem('santaDrawn2025',JSON.stringify(drawn));
      // åªé¡¯ç¤ºä¸€æ¬¡ï¼Œ3ç§’å¾Œæ¸…é™¤ localStorage
      setTimeout(()=>{
        resetPerson(sel);
        document.getElementById('drawarea').style.display='';
        document.getElementById('lotteryCard').style.display='none';
        document.getElementById('reminder').innerHTML = `<span style="color:#E23">${sel}å·²æŠ½å®Œï¼ˆä¸èƒ½é‡è¦†æŸ¥çœ‹ï¼‰ï¼</span>`;
      }, 3000); // 3ç§’å¾Œå°±æ¸…
    }
    function flip(){
      document.getElementById('flipInner').classList.add('flipped');
    }
    function showOnceOnly(sel,already=false){
      document.getElementById('entry').style.display='none';
      document.getElementById('drawarea').style.display='';
      document.getElementById('lotteryCard').style.display='none';
      document.getElementById('reminder').innerHTML = already
        ? `<span style="color:red">${sel} å·²ç¶“æŠ½éï¼ˆä¸èƒ½é‡è¦†æŸ¥çœ‹ï¼‰ï¼</span>` : `<span style="color:#E23">${sel}å·²æŠ½å®Œï¼ˆä¸èƒ½é‡è¦†æŸ¥çœ‹ï¼‰ï¼</span>`;
    }
    function resetPerson(sel){
      // ç§»é™¤æŠ½éçš„äººï¼Œé˜²æ­¢ reload
      let xdrawn=JSON.parse(localStorage.getItem('santaDrawn2025')||'{}');
      if(xdrawn[sel]) delete xdrawn[sel];
      localStorage.setItem('santaDrawn2025',JSON.stringify(xdrawn));
    }
    // Organizer resetï¼šæ¸…é™¤æ‰€æœ‰ pairing + æŠ½çè¨˜éŒ„
    function resetAll(){
      localStorage.removeItem('santaPairs2025');
      localStorage.removeItem('santaDrawn2025');
      location.reload();
    }
  </script>
</body>
</html>
